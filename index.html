<!DOCTYPE html>
<html lang="en">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-D4VPZBZ8T4"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-D4VPZBZ8T4');
</script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Where's My Antipode?</title>
  <meta property="og:title" content="Where's My Antipode?">
  <meta property="og:description" content="Find the exact opposite point on Earth">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://cheesedongjin.github.io/CheeseV/">
  <link rel="icon" href="icon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("sw.js");
      });
    }
  </script>
</head>
<body>
  <header>
    <span id="title">
      <img src="icon.png" alt="Icon">
      Where's My Antipode?
    </span>
    <nav><a href="other-sites/addresses">Other Sites by Jdeseech</a></nav>
  </header>

  <div id="globe-container">
    <div id="globeViz"></div>
  </div>

  <div class="control-panel" id="controlPanel">
    <div class="panel-header" id="panelHeader">
      <div class="panel-title">
        <span>🌍</span>
        <span>Antipode Finder</span>
      </div>
      <button class="toggle-btn" id="toggleBtn">▼</button>
    </div>

    <div class="panel-content">
      <div class="instruction">
        <div class="instruction-title">🌍 Find Your Antipode</div>
        <div class="instruction-text">Right-click anywhere on the globe or enter coordinates below</div>
      </div>

      <form id="coord-form">
        <div class="input-group">
          <label for="latInput">Latitude</label>
          <input id="latInput" type="number" step="0.01" min="-90" max="90" placeholder="0.00" />
        </div>
        <div class="input-group">
          <label for="lngInput">Longitude</label>
          <input id="lngInput" type="number" step="0.01" min="-180" max="180" placeholder="0.00" />
        </div>
        <button type="submit">🔍 Find Antipode</button>
      </form>

      <div id="info" style="display: none;">
        <div class="result-info">
          <div class="location-card">
            <div class="location-title">📍 Clicked Location</div>
            <div class="location-name" id="clicked-name">Loading...</div>
            <div class="location-coords" id="clicked-coords"></div>
          </div>
          <div class="location-card antipode">
            <div class="location-title">🌏 Antipode</div>
            <div class="location-name" id="antipode-name">Loading...</div>
            <div class="location-coords" id="antipode-coords"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import * as THREE from 'https://esm.sh/three@0.153.0';
    import Globe from 'https://esm.sh/globe.gl@2.41.1';

    // 패널 토글 함수
    function togglePanel() {
      const panel = document.getElementById('controlPanel');
      const toggleBtn = document.getElementById('toggleBtn');

      panel.classList.toggle('collapsed');
      toggleBtn.textContent = panel.classList.contains('collapsed') ? '▲' : '▼';
    }

    // Attach event listener to the panel header
    document.getElementById('panelHeader').addEventListener('click', togglePanel);togglePanel = togglePanel;

    // Globe 초기화
    const world = Globe()(document.getElementById('globeViz'))
      .globeImageUrl('https://unpkg.com/three-globe/example/img/earth-night.jpg')
      .pointOfView({ lat: 0, lng: 0, altitude: 2 })
      .backgroundColor('rgba(0,0,0,0)');

    // 마커와 선을 담을 그룹
    const markerGroup = new THREE.Group();
    world.scene().add(markerGroup);
    const lineGroup = new THREE.Group();
    world.scene().add(lineGroup);
    const markers = [];

    // 마커 생성 함수 (개선된 디자인)
    function createMarker(color, isAntipode = false) {
      const mat = new THREE.MeshPhongMaterial({
        color,
        shininess: 100,
        transparent: true,
        opacity: 0.9
      });

      const sphere = new THREE.Mesh(new THREE.SphereGeometry(1.5, 32, 32), mat);

      // 글로우 효과
      const glowMat = new THREE.MeshBasicMaterial({
        color: color,
        transparent: true,
        opacity: 0.3
      });
      const glowSphere = new THREE.Mesh(new THREE.SphereGeometry(2.5, 16, 16), glowMat);

      sphere.add(glowSphere);
      return sphere;
    }

    function setMarkerPosition(marker, lat, lng, altitude) {
      const { x, y, z } = world.getCoords(lat, lng, altitude);
      marker.position.set(x, y, z);
      marker.lookAt(0, 0, 0);
    }

    // 개선된 안티포드 선
    function createAntipodeLine(lat, lng, antiLat, antiLng) {
      const a = world.getCoords(lat, lng, 0.5);
      const b = world.getCoords(lat, lng, 0.1);
      const c = world.getCoords(antiLat, antiLng, 0.1);
      const d = world.getCoords(antiLat, antiLng, 0.5);

      const pts = [
        new THREE.Vector3(a.x, a.y, a.z),
        new THREE.Vector3(b.x, b.y, b.z),
        new THREE.Vector3(c.x, c.y, c.z),
        new THREE.Vector3(d.x, d.y, d.z)
      ];

      const geom = new THREE.BufferGeometry().setFromPoints(pts);
      const mat = new THREE.LineDashedMaterial({
        color: 0x4f46e5,
        dashSize: 2,
        gapSize: 1,
        opacity: 0.8,
        transparent: true,
        linewidth: 2
      });

      const line = new THREE.Line(geom, mat);
      line.computeLineDistances();
      return line;
    }

    function clearMarkers() {
      markerGroup.clear();
      markers.length = 0;
    }

    function clearLines() {
      lineGroup.clear();
    }

    // 개선된 마커 애니메이션
    function animateMarkers() {
      markers.forEach(m => {
        m.userData.t += 0.015;
        const alt = 0.51 + 0.03 * Math.sin(m.userData.t);
        setMarkerPosition(m, m.userData.lat, m.userData.lng, alt);
        m.rotateY(0.02);

        // 글로우 효과 애니메이션
        if (m.children[0]) {
          m.children[0].material.opacity = 0.2 + 0.1 * Math.sin(m.userData.t * 2);
        }
      });
      requestAnimationFrame(animateMarkers);
    }
    animateMarkers();

    const info = document.getElementById('info');
    const form = document.getElementById('coord-form');
    const latInput = document.getElementById('latInput');
    const lngInput = document.getElementById('lngInput');

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const lat = parseFloat(latInput.value);
      const lng = parseFloat(lngInput.value);
      if (isNaN(lat) || isNaN(lng)) {
        showNotification('Please enter valid coordinates', 'error');
        return;
      }
      showAntipode(lat, lng);
    });

    // 알림 표시
    function showNotification(message, type = 'success') {
      const notification = document.createElement('div');
      notification.className = `success-message ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);

      setTimeout(() => notification.classList.add('show'), 100);
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // 개선된 지오코딩
    function reverseGeocode(lat, lng) {
      return fetch(
        `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&zoom=10`
      )
        .then(res => res.json())
        .then(data => {
          if (data.error) return 'Unknown location';
          const addr = data.address || {};
          return addr.city || addr.town || addr.village || addr.state || addr.country || 'Ocean';
        })
        .catch(() => 'Unknown location');
    }

    // 개선된 안티포드 표시
    function showAntipode(lat, lng) {
      const antiLat = -lat;
      const antiLng = lng >= 0 ? lng - 180 : lng + 180;

      clearMarkers();
      clearLines();

      // 마커 생성
      const clickedMarker = createMarker(0xf59e0b, false);
      clickedMarker.userData = { lat, lng, t: 0 };
      markerGroup.add(clickedMarker);
      markers.push(clickedMarker);
      setMarkerPosition(clickedMarker, lat, lng, 1.01);

      const antipodeMarker = createMarker(0xef4444, true);
      antipodeMarker.userData = { lat: antiLat, lng: antiLng, t: Math.PI };
      markerGroup.add(antipodeMarker);
      markers.push(antipodeMarker);
      setMarkerPosition(antipodeMarker, antiLat, antiLng, 1.01);

      lineGroup.add(createAntipodeLine(lat, lng, antiLat, antiLng));

      // UI 업데이트
      info.style.display = 'block';
      document.getElementById('clicked-coords').textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
      document.getElementById('antipode-coords').textContent = `${antiLat.toFixed(4)}, ${antiLng.toFixed(4)}`;

      // 로딩 상태
      document.getElementById('clicked-name').textContent = 'Loading...';
      document.getElementById('antipode-name').textContent = 'Loading...';
      document.getElementById('clicked-name').classList.add('loading');
      document.getElementById('antipode-name').classList.add('loading');

      // 지명 정보 업데이트
      Promise.all([reverseGeocode(lat, lng), reverseGeocode(antiLat, antiLng)])
        .then(([clickedLoc, antipodeLoc]) => {
          document.getElementById('clicked-name').textContent = clickedLoc;
          document.getElementById('antipode-name').textContent = antipodeLoc;
          document.getElementById('clicked-name').classList.remove('loading');
          document.getElementById('antipode-name').classList.remove('loading');
        })
        .catch(() => {
          document.getElementById('clicked-name').textContent = 'Unknown location';
          document.getElementById('antipode-name').textContent = 'Unknown location';
          document.getElementById('clicked-name').classList.remove('loading');
          document.getElementById('antipode-name').classList.remove('loading');
        });

      world.pointOfView({ lat: antiLat, lng: antiLng, altitude: 2 }, 700);
      showNotification('Antipode found! 🌍');

      // 패널이 접혀있다면 자동으로 펼치기
      const panel = document.getElementById('controlPanel');
      if (panel.classList.contains('collapsed')) {
        togglePanel();
      }
    }

    world.onGlobeRightClick(({ lat, lng }) => {
      showAntipode(lat, lng);
    });
  </script>
</body>
</html>